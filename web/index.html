<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Pocket Signal</title>
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

  <style>
    :root{
      --bg:#070A12;
      --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.12);
      --shadow:0 18px 50px rgba(0,0,0,.55);
      --radius:22px;

      --blue:#3B82F6;
      --blue2:#0EA5E9;
      --deep:#0B1637;

      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);

      --buy:#22C55E;
      --sell:#EF4444;
      --wait:#F59E0B;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    *{box-sizing:border-box}

    .hero{
      position:relative;height:320px;overflow:hidden;
      background:
        radial-gradient(900px 420px at 50% 25%, rgba(59,130,246,.30), transparent 60%),
        radial-gradient(900px 420px at 70% 10%, rgba(14,165,233,.18), transparent 55%),
        linear-gradient(to bottom, rgba(5,6,10,0), rgba(5,6,10,.86));
    }
    #bg{position:absolute;inset:0;width:100%;height:100%;display:block;z-index:0;pointer-events:none;}
    .heroOverlay{position:absolute;inset:0;display:flex;align-items:flex-end;padding:14px;z-index:2;background:linear-gradient(to bottom, rgba(5,6,10,.10), rgba(5,6,10,.90));}
    .heroCard{
      width:100%;max-width:560px;margin:0 auto;background:var(--card);
      border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);
      backdrop-filter: blur(12px);padding:14px 16px;
    }
    .headRow{display:flex;align-items:center;gap:12px}

    .logo{
      width:56px;height:56px;border-radius:50%;
      position:relative;overflow:hidden;flex:0 0 auto;
      display:grid;place-items:center;background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.15);
      box-shadow: 0 18px 40px rgba(0,0,0,.55);
    }
    .logo img{width:76%;height:76%;object-fit:contain;filter:drop-shadow(0 6px 10px rgba(0,0,0,.35));}
    .logo::before{
      content:"";position:absolute;inset:-12px;border-radius:50%;
      background: conic-gradient(from 0deg,
        rgba(59,130,246,0) 0%,
        rgba(59,130,246,.85) 18%,
        rgba(14,165,233,.95) 40%,
        rgba(59,130,246,.10) 65%,
        rgba(59,130,246,0) 100%);
      animation: spinGlow 2.8s linear infinite;opacity:.85;z-index:-1;
    }
    .logo::after{
      content:"";position:absolute;inset:-16px;border-radius:50%;
      background: radial-gradient(circle, rgba(14,165,233,.22), transparent 65%);z-index:-2;
    }
    @keyframes spinGlow{to{transform:rotate(360deg)}}
    body.buy  .logo::before{background:conic-gradient(from 0deg, rgba(34,197,94,0) 0%, rgba(34,197,94,.95) 30%, rgba(59,130,246,.10) 70%, rgba(34,197,94,0) 100%);}
    body.sell .logo::before{background:conic-gradient(from 0deg, rgba(239,68,68,0) 0%, rgba(239,68,68,.95) 30%, rgba(59,130,246,.10) 70%, rgba(239,68,68,0) 100%);}
    body.wait .logo::before{background:conic-gradient(from 0deg, rgba(245,158,11,0) 0%, rgba(245,158,11,.95) 30%, rgba(59,130,246,.10) 70%, rgba(245,158,11,0) 100%);}

    .heroTitle{font-size:28px;margin:0;letter-spacing:.2px}
    .heroSub{margin-top:4px;color:var(--muted);font-weight:700}

    .ui{position:relative;z-index:5;padding:14px}
    .card{
      width:100%;max-width:560px;margin:-22px auto 0;background:var(--card);
      border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);
      backdrop-filter: blur(12px);padding:14px 14px 16px;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.88);font-weight:800;user-select:none;
    }
    .pill b{color:#fff}
    .controls{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
    select{
      appearance:none;background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;padding:10px 12px;border-radius:12px;
      font-weight:900;outline:none;
    }
    option{color:#000}

    .out{margin:12px 2px 6px;color:rgba(255,255,255,.82);line-height:1.35;font-weight:800}
    .sigTime{margin:6px 2px 10px;font-size:13px;opacity:.92;font-weight:800}

    .risk{
      margin:10px 2px 6px;
      padding:10px 12px;border-radius:14px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      color:rgba(255,255,255,.85);
      font-weight:900;
    }
    .risk small{display:block;opacity:.8;font-weight:800;margin-top:4px;line-height:1.3}

    .bars{display:grid;gap:10px;margin:10px 0 12px}
    .barLine{display:flex;justify-content:space-between;align-items:center;color:rgba(255,255,255,.70);font-weight:900;font-size:13px;margin-bottom:6px}
    .bar{height:12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);overflow:hidden;}
    .bar > div{height:100%;width:0%;border-radius:999px;background:linear-gradient(90deg, rgba(59,130,246,.95), rgba(14,165,233,.95));transition:width .35s ease;}

    .tfRow{display:flex;gap:8px;align-items:center;margin:10px 0 12px;flex-wrap:wrap}
    .tf{padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#fff;font-weight:1000}
    .tf.active{background:rgba(59,130,246,.35);border-color:rgba(59,130,246,.55);}
    #otsToggle.disabled{opacity:.4;pointer-events:none;}
    #otsToggle.active{background:rgba(245,158,11,.22);border-color:rgba(245,158,11,.45);}
    .timer{
      margin-left:auto;font-size:13px;opacity:.95;padding:8px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);
      min-width:190px;text-align:center;font-weight:1000;
    }

    .btn{
      width:100%;border:none;border-radius:16px;padding:14px 14px;
      font-weight:1000;font-size:18px;color:#0b1020;
      background:linear-gradient(90deg, rgba(99,102,241,1), rgba(59,130,246,1));
      box-shadow: 0 16px 38px rgba(59,130,246,.25);
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px);opacity:.92}
    .btn:disabled{opacity:.45;cursor:not-allowed;}

    .stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:12px}
    .stat{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:10px 10px;text-align:center;}
    .k{color:rgba(255,255,255,.75);font-weight:900;font-size:12px}
    .v{font-size:20px;font-weight:1000;margin-top:4px}
    .v small{display:block;font-size:12px;opacity:.8;font-weight:900;margin-top:2px}

    .listWrap{margin-top:14px}
    .listTitle{margin:0 0 8px;font-weight:1000;font-size:20px}
    .list{display:grid;gap:10px;max-height:220px;overflow:auto;padding-right:4px;}
    .item{
      display:flex;justify-content:space-between;align-items:center;
      background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10);
      border-radius:14px;padding:10px 12px;font-weight:900;
    }
    .tag{padding:6px 10px;border-radius:999px;font-weight:1000;font-size:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);}
    .tag.buy{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.35)}
    .tag.sell{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.35)}
    .tag.wait{background:rgba(245,158,11,.18);border-color:rgba(245,158,11,.35)}
    .tag.win{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.35)}
    .tag.loss{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.33)}
    .tag.skip{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.16)}

    .footer{padding:12px 14px 22px}
    .footer .box{
      max-width:560px;margin:0 auto;text-align:center;
      background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);
      border-radius:18px;padding:12px;color:rgba(255,255,255,.75);font-weight:1000;
    }

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:99999;padding:16px;}
    .modal.show{display:flex;}
    .modalCard{width:min(420px,100%);background:rgba(20,22,30,.96);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:14px;box-shadow:0 30px 70px rgba(0,0,0,.6);}
    .modalTitle{font-size:18px;font-weight:1000;margin-bottom:6px;color:#fff;}
    .modalSub{font-size:13px;opacity:.95;margin-bottom:12px;color:#fff;line-height:1.35}
    .modalBtns{display:flex;gap:10px;}
    .mBtn{width:100%;padding:12px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;font-weight:1000;}
    .mBtn.win{background:rgba(16,185,129,.22);border-color:rgba(16,185,129,.35);}
    .mBtn.loss{background:rgba(239,68,68,.20);border-color:rgba(239,68,68,.33);}
    .mBtn.ghost{margin-top:10px;opacity:.9;}

    /* Analyzing */
    .an{display:inline-flex;align-items:center;gap:10px}
    .spinner{
      width:16px;height:16px;border-radius:50%;
      border:2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.85);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .dim{opacity:.8;font-weight:900}
  </style>
</head>

<body class="wait">
  <div class="hero">
    <canvas id="bg"></canvas>
    <div class="heroOverlay">
      <div class="heroCard">
        <div class="headRow">
          <div class="logo"><img src="/web/pocketlogo.png" alt="Pocket"></div>
          <div style="min-width:0">
            <h1 class="heroTitle">Pocket Signal</h1>
            <div class="heroSub" id="moti"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="ui">
    <div class="card">
      <div class="row">
        <span class="pill">üìå Pair: <b id="pair">EURUSD (OTC)</b></span>
        <span class="pill">üìä RSI: <b id="rsi">‚Äî</b></span>
        <span class="pill">üìà EMA200: <b id="ema">‚Äî</b></span>
        <span class="pill">‚ö° Signal: <b id="sig">WAIT</b></span>
      </div>

      <div class="controls">
        <select id="pairSel"></select>
        <select id="tfSel">
          <option value="M1" selected>M1</option>
          <option value="M5">M5</option>
          <option value="M15">M15</option>
        </select>
      </div>

      <div class="risk">
        üí° Risk: 1 signal = balansning <b>2‚Äì3%</b>
        <small>Ketma-ket 2 ta LOSS bo‚Äòlsa bot 10 daqiqa pauza qiladi (xavfsiz).</small>
      </div>

      <div class="out" id="out">Tayyor. ‚ÄúSignal olish‚Äùni bos. Signal 1 daqiqa oldindan beriladi.</div>
      <div class="sigTime" id="sigTime">üïí Kirish: ‚Äî | Tugash: ‚Äî</div>

      <div class="tfRow">
        <button class="tf active" data-sec="60">M1</button>
        <button class="tf" data-sec="300">M5</button>
        <button class="tf" data-sec="900">M15</button>
        <button class="tf" id="otsToggle">OTS</button>
        <div class="timer" id="timer">‚è≥ Tayyor (M1)</div>
      </div>

      <div class="bars">
        <div>
          <div class="barLine"><span>Confidence</span><span id="confTxt">‚Äî%</span></div>
          <div class="bar"><div id="confBar"></div></div>
        </div>
        <div>
          <div class="barLine"><span>Winrate (last 20)</span><span id="accTxt">‚Äî%</span></div>
          <div class="bar"><div id="accBar"></div></div>
        </div>
      </div>

      <button class="btn" id="btn">üöÄ Signal olish</button>

      <div class="stats">
        <div class="stat">
          <div class="k">‚úÖ/‚ùå Umumiy</div>
          <div class="v"><span id="winAll">0</span> / <span id="lossAll">0</span></div>
          <div class="v"><small>WR: <span id="wrAll">0%</span></small></div>
        </div>
        <div class="stat">
          <div class="k">üìÖ Bugun</div>
          <div class="v"><span id="wrToday">0%</span></div>
          <div class="v"><small><span id="todayWL">0/0</span></small></div>
        </div>
        <div class="stat">
          <div class="k">üóì 7 kun</div>
          <div class="v"><span id="wr7">0%</span></div>
          <div class="v"><small><span id="wl7">0/0</span></small></div>
        </div>
      </div>

      <div class="listWrap">
        <p class="listTitle">Oxirgi 20 signal</p>
        <div class="list" id="list"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="box">‚ö†Ô∏è Bu demo analitika. Real natija uchun riskni boshqar.</div>
  </div>

  <div class="modal" id="resultModal">
    <div class="modalCard">
      <div class="modalTitle">Natija?</div>
      <div class="modalSub" id="modalInfo">Signal yakunlandi.</div>
      <div class="modalBtns">
        <button class="mBtn win" id="markWin">‚úÖ Win</button>
        <button class="mBtn loss" id="markLoss">‚ùå Loss</button>
      </div>
      <button class="mBtn ghost" id="markSkip">Keyin</button>
    </div>
  </div>

  <script>
    /* ========= MOTIVATION ========= */
    const motiList = [
      "Sabrli bo‚Äòlgan yutadi.",
      "Riskni boshqar ‚Äî foyda o‚Äòzi keladi.",
      "Intizom ‚Äî signalning yarmi.",
      "Kam kir, to‚Äòg‚Äòri kir.",
      "Stop-loss ‚Äî eng yaxshi do‚Äòst.",
      "Bugun o‚Äòrgan, ertaga ishlab ol."
    ];
    const motiEl = document.getElementById("moti");
    const pick = a => a[Math.floor(Math.random()*a.length)];
    function setMoti(){ motiEl.textContent = pick(motiList); }
    setMoti(); setInterval(setMoti, 10000);

    /* ========= HELPERS ========= */
    const pad = n => String(n).padStart(2,"0");
    const fmt = sec => `${pad(Math.floor(sec/60))}:${pad(sec%60)}`;
    const hhmmss = ms => { const d=new Date(ms); return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; };
    const dayKey = (d=new Date()) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

    /* ========= ELEMENTS ========= */
    const pairSel = document.getElementById("pairSel");
    const tfSel   = document.getElementById("tfSel");
    const pairEl  = document.getElementById("pair");
    const rsiEl   = document.getElementById("rsi");
    const emaEl   = document.getElementById("ema");
    const sigEl   = document.getElementById("sig");
    const outEl   = document.getElementById("out");
    const sigTimeEl = document.getElementById("sigTime");

    const confBar = document.getElementById("confBar");
    const accBar  = document.getElementById("accBar");
    const confTxt = document.getElementById("confTxt");
    const accTxt  = document.getElementById("accTxt");

    const btn = document.getElementById("btn");
    const timerEl = document.getElementById("timer");

    const winAllEl = document.getElementById("winAll");
    const lossAllEl= document.getElementById("lossAll");
    const wrAllEl  = document.getElementById("wrAll");
    const wrTodayEl= document.getElementById("wrToday");
    const todayWLEl= document.getElementById("todayWL");
    const wr7El    = document.getElementById("wr7");
    const wl7El    = document.getElementById("wl7");
    const listEl   = document.getElementById("list");

    /* ========= OTC RULES (Weekend) =========
       getDay(): 0=Yakshanba, 6=Shanba -> OTC
    */
    const otsBtn = document.getElementById("otsToggle");
    let useOTS = true;
    function isWeekendOTC(){
      const d = new Date();
      const g = d.getDay();
      return (g === 0 || g === 6);
    }
    function setOTCState(){
      const weekend = isWeekendOTC();
      if(weekend){
        otsBtn.classList.remove("disabled");
        useOTS = true;
        otsBtn.classList.add("active");
        otsBtn.textContent = "OTS ‚úì";
      }else{
        // weekday: OTC yopiq
        useOTS = false;
        otsBtn.classList.remove("active");
        otsBtn.classList.add("disabled");
        otsBtn.textContent = "OTS (yopiq)";
      }
    }
    setOTCState();

    otsBtn.onclick = () => {
      // faqat weekendda toggle qilish mumkin (weekdayda disabled)
      if(otsBtn.classList.contains("disabled")) return;
      useOTS = !useOTS;
      otsBtn.classList.toggle("active", useOTS);
      otsBtn.textContent = useOTS ? "OTS ‚úì" : "OTS";
      rebuildPairs();
    };

    const PAIRS_NORMAL = ["EURUSD","GBPUSD","USDJPY","AUDUSD","USDCAD","NZDUSD","EURJPY","EURGBP","USDCHF","GBPJPY","AUDJPY"];
    const PAIRS_OTS = [
      "EURUSD (OTC)","GBPUSD (OTC)","USDJPY (OTC)","AUDUSD (OTC)","USDCAD (OTC)","NZDUSD (OTC)",
      "EURJPY (OTC)","EURGBP (OTC)","GBPJPY (OTC)","EURCHF (OTC)","USDCHF (OTC)","AUDJPY (OTC)","CADJPY (OTC)","EURAUD (OTC)","GBPAUD (OTC)"
    ];

    function rebuildPairs(){
      const list = useOTS ? PAIRS_OTS : PAIRS_NORMAL;
      pairSel.innerHTML = list.map(p=>`<option value="${p}">${p}</option>`).join("");
      pairSel.value = list[0];
      pairEl.textContent = pairSel.value;
    }
    rebuildPairs();
    pairSel.onchange = () => { pairEl.textContent = pairSel.value; };

    /* ========= TIMEFRAME BUTTONS ========= */
    const tfBtns = Array.from(document.querySelectorAll(".tfRow .tf[data-sec]"));
    let tfSec = 60;
    tfBtns.forEach(b=>{
      b.onclick = ()=>{
        tfBtns.forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        tfSec = Number(b.dataset.sec||60);
        timerEl.textContent = "‚è≥ Tayyor (" + (tfSec===60?"M1":tfSec===300?"M5":"M15") + ")";
        tfSel.value = (tfSec===60?"M1":tfSec===300?"M5":"M15");
      };
    });
    tfSel.onchange = ()=>{
      const v = tfSel.value;
      const sec = v==="M1"?60: v==="M5"?300:900;
      tfSec = sec;
      tfBtns.forEach(x=>x.classList.remove("active"));
      tfBtns.find(x=>Number(x.dataset.sec)===sec)?.classList.add("active");
      timerEl.textContent = "‚è≥ Tayyor (" + v + ")";
    };

    /* ========= PRICE FEED (SIMULATION) =========
       Real ulash: backenddan candles olib shu arrayni to'ldirasan.
    */
    const FEED = {};
    function ensureSeries(pair){
      if(FEED[pair]) return FEED[pair];
      const arr = [];
      let p = 1.1000 + Math.random()*0.01;
      for(let i=0;i<350;i++){
        p += (Math.random()-0.5)*0.0012;
        arr.push(p);
      }
      FEED[pair] = arr;
      return arr;
    }
    function tickSeries(pair){
      const s = ensureSeries(pair);
      const last = s[s.length-1];
      const drift = (Math.random()-0.5)*0.0011;
      const next = Math.max(0.5, last + drift);
      s.push(next);
      if(s.length>600) s.shift();
      return next;
    }

    /* ========= INDICATORS ========= */
    function ema(values, period){
      if(values.length < period) return null;
      const k = 2/(period+1);
      let e = values[0];
      for(let i=1;i<values.length;i++) e = values[i]*k + e*(1-k);
      return e;
    }
    function rsi(values, period=14){
      if(values.length < period+1) return null;
      let gains=0, losses=0;
      for(let i=values.length-period;i<values.length;i++){
        const diff = values[i]-values[i-1];
        if(diff>=0) gains += diff; else losses += -diff;
      }
      const avgG = gains/period;
      const avgL = losses/period;
      if(avgL === 0) return 100;
      const rs = avgG/avgL;
      return Math.round(100 - (100/(1+rs)));
    }

    /* ========= SIGNAL LOGIC (RSI + EMA200) =========
       BUY: RSI <= 30 AND price > EMA200 (trend up)  [konservativ]
       SELL: RSI >= 70 AND price < EMA200 (trend down)
       else WAIT
    */
    function calcSignal(pair){
      const s = ensureSeries(pair);
      // make a few ticks to feel "live"
      for(let i=0;i<4;i++) tickSeries(pair);
      const price = s[s.length-1];
      const r = rsi(s, 14);
      const e200 = ema(s.slice(-260), 200); // last 260 points for stability
      if(r==null || e200==null) return {type:"wait", rsi:"‚Äî", ema:"‚Äî", conf:55};

      let type = "wait";
      // conservative filters
      if(r <= 30 && price > e200) type = "buy";
      else if(r >= 70 && price < e200) type = "sell";
      else type = "wait";

      // confidence
      let conf = 55;
      if(type==="buy") conf = Math.min(95, 70 + Math.round((30 - r)*0.8));
      if(type==="sell") conf = Math.min(95, 70 + Math.round((r - 70)*0.8));
      if(type==="wait") conf = 55 + Math.round(Math.random()*8);

      return {type, rsi:r, ema: e200.toFixed(5), conf};
    }

    /* ========= STORAGE (signals log + results) ========= */
    function load(){
      return {
        all: JSON.parse(localStorage.getItem("allLog")||"[]"), // items: {t, pair, tf, sig, res}
        lossStreak: Number(localStorage.getItem("lossStreak")||0),
        pauseUntil: Number(localStorage.getItem("pauseUntil")||0)
      };
    }
    function save(st){
      localStorage.setItem("allLog", JSON.stringify(st.all.slice(0,400)));
      localStorage.setItem("lossStreak", String(st.lossStreak));
      localStorage.setItem("pauseUntil", String(st.pauseUntil));
    }

    function computeStats(all){
      const wins = all.filter(x=>x.res==="WIN").length;
      const loss = all.filter(x=>x.res==="LOSS").length;
      const total = wins+loss;
      const wr = total ? Math.round((wins/total)*100) : 0;

      const today = dayKey(new Date());
      const y = new Date(); y.setDate(y.getDate()-1);
      const yesterday = dayKey(y);

      const todayArr = all.filter(x=>x.day===today && (x.res==="WIN"||x.res==="LOSS"));
      const tW = todayArr.filter(x=>x.res==="WIN").length;
      const tL = todayArr.filter(x=>x.res==="LOSS").length;
      const tWR = (tW+tL)? Math.round((tW/(tW+tL))*100) : 0;

      const seven = new Date(); seven.setDate(seven.getDate()-6);
      const sevenKey = dayKey(seven);
      // include last 7 days by date compare
      const last7 = all.filter(x=>x.day >= sevenKey && (x.res==="WIN"||x.res==="LOSS"));
      const sW = last7.filter(x=>x.res==="WIN").length;
      const sL = last7.filter(x=>x.res==="LOSS").length;
      const sWR = (sW+sL)? Math.round((sW/(sW+sL))*100) : 0;

      // last 20 winrate
      const last20 = all.filter(x=>x.res==="WIN"||x.res==="LOSS").slice(0,20);
      const lW = last20.filter(x=>x.res==="WIN").length;
      const lL = last20.filter(x=>x.res==="LOSS").length;
      const lWR = (lW+lL)? Math.round((lW/(lW+lL))*100) : 0;

      return {wins,loss,wr,tW,tL,tWR,sW,sL,sWR,lWR};
    }

    function render(){
      const st = load();
      const all = st.all;

      const S = computeStats(all);
      winAllEl.textContent = S.wins;
      lossAllEl.textContent = S.loss;
      wrAllEl.textContent = S.wr + "%";
      wrTodayEl.textContent = S.tWR + "%";
      todayWLEl.textContent = `${S.tW}/${S.tL}`;
      wr7El.textContent = S.sWR + "%";
      wl7El.textContent = `${S.sW}/${S.sL}`;

      accBar.style.width = S.lWR + "%";
      accTxt.textContent = S.lWR + "%";

      // last 20 signals list (regardless of result)
      listEl.innerHTML = "";
      st.all.slice(0,20).forEach(x=>{
        const row = document.createElement("div");
        row.className="item";
        row.innerHTML = `
          <div>${x.time} ‚Ä¢ ${x.pair} ‚Ä¢ ${x.tf}</div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="tag ${x.type}">${x.sig}</div>
            <div class="tag ${x.res==="WIN"?"win":x.res==="LOSS"?"loss":"skip"}">${x.res==="WIN"?"‚úÖ":x.res==="LOSS"?"‚ùå":"‚è∏"}</div>
          </div>
        `;
        listEl.appendChild(row);
      });

      // pause UI
      updatePauseUI();
    }

    /* ========= PAUSE (2 losses => 10 min) ========= */
    function updatePauseUI(){
      const st = load();
      const now = Date.now();
      if(st.pauseUntil && now < st.pauseUntil){
        const left = Math.ceil((st.pauseUntil-now)/1000);
        btn.disabled = true;
        timerEl.textContent = "‚õî Pauza: " + fmt(left);
        outEl.innerHTML = `‚õî Ketma-ket 2 LOSS. <span class="dim">10 daqiqa pauza</span> (xavfsiz).`;
      }else{
        btn.disabled = false;
        if(!running) timerEl.textContent = "‚è≥ Tayyor (" + (tfSec===60?"M1":tfSec===300?"M5":"M15") + ")";
      }
    }
    setInterval(updatePauseUI, 1000);

    /* ========= ANALYZING + DELAY ========= */
    function setAnalyzing(sec){
      outEl.innerHTML = `<span class="an"><span class="spinner"></span> Analiz qilinyapti... <span class="dim">(${sec}s)</span></span>`;
    }

    /* ========= SIGNAL SET ========= */
    function setSignalUI(type, rsiV, emaV, conf){
      document.body.classList.remove("buy","sell","wait");
      document.body.classList.add(type);

      sigEl.textContent = type.toUpperCase();
      rsiEl.textContent = String(rsiV);
      emaEl.textContent = String(emaV);

      confBar.style.width = conf + "%";
      confTxt.textContent = conf + "%";
    }

    /* ========= TIMER FLOW (1 min before + expiry + modal) ========= */
    const PREP_SEC = 60;
    let running=false;
    let phase="idle"; // prep|trade|idle
    let tLeft=0;
    let tInterval=null;

    function setTimes(entryMs, endMs){
      sigTimeEl.textContent = `üïí Kirish: ${hhmmss(entryMs)} | Tugash: ${hhmmss(endMs)}`;
    }

    const modal = document.getElementById("resultModal");
    const modalInfo = document.getElementById("modalInfo");
    const markWin = document.getElementById("markWin");
    const markLoss = document.getElementById("markLoss");
    const markSkip = document.getElementById("markSkip");

    function openModal(text){ modalInfo.textContent=text; modal.classList.add("show"); }
    function closeModal(){ modal.classList.remove("show"); }
    modal.addEventListener("click",(e)=>{ if(e.target===modal) closeModal(); });

    // pending result item index (so we can update res after modal)
    let pendingId = null;

    function startTimerFlow(){
      if(running) return;
      running = true;

      const now = Date.now();
      const entryAt = now + PREP_SEC*1000;
      const endAt = entryAt + tfSec*1000;
      setTimes(entryAt, endAt);

      phase="prep";
      tLeft=PREP_SEC;
      timerEl.textContent = "‚è≥ Kirishgacha: " + fmt(tLeft);

      tInterval = setInterval(()=>{
        tLeft--;
        if(phase==="prep"){
          timerEl.textContent = "‚è≥ Kirishgacha: " + fmt(Math.max(0,tLeft));
          if(tLeft<=0){
            phase="trade";
            tLeft=tfSec;
            timerEl.textContent = "‚è≥ Tugashgacha: " + fmt(tLeft);
          }
        }else if(phase==="trade"){
          timerEl.textContent = "‚è≥ Tugashgacha: " + fmt(Math.max(0,tLeft));
          if(tLeft<=0){
            clearInterval(tInterval); tInterval=null;
            running=false; phase="idle";
            openModal(`${pairSel.value} ‚Ä¢ ${tfSel.value} tugadi. Natija?`);
          }
        }
      },1000);
    }

    function addPendingLog(sigType){
      const st = load();
      const d = new Date();
      const time = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
      const item = {
        id: String(Date.now()) + "_" + Math.floor(Math.random()*9999),
        day: dayKey(d),
        time,
        pair: pairSel.value,
        tf: tfSel.value,
        sig: sigType.toUpperCase(),
        type: sigType,
        res: "SKIP"
      };
      st.all.unshift(item);
      st.all = st.all.slice(0,400);
      save(st);
      pendingId = item.id;
      render();
    }

    function updateResult(res){
      const st = load();
      const idx = st.all.findIndex(x=>x.id===pendingId);
      if(idx>=0){
        st.all[idx].res = res;
      }
      // loss streak + pause
      if(res==="LOSS"){
        st.lossStreak = (st.lossStreak||0) + 1;
      }else if(res==="WIN"){
        st.lossStreak = 0;
      }

      if(st.lossStreak >= 2){
        st.pauseUntil = Date.now() + 10*60*1000; // 10 min
        st.lossStreak = 0; // reset after pause triggered
      }

      save(st);
      pendingId = null;
      render();
    }

    markWin.onclick  = ()=>{ updateResult("WIN");  closeModal(); };
    markLoss.onclick = ()=>{ updateResult("LOSS"); closeModal(); };
    markSkip.onclick = ()=>{ /* keep SKIP */ closeModal(); };

    /* ========= MAIN: SIGNAL BUTTON ========= */
    btn.onclick = () => {
      setOTCState(); // update weekend/weekday live

      const st = load();
      if(st.pauseUntil && Date.now() < st.pauseUntil){
        updatePauseUI();
        return;
      }

      // anti-copy delay 5-10s
      const delay = 5 + Math.floor(Math.random()*6);
      let left = delay;
      setAnalyzing(left);

      const tick = setInterval(()=>{
        left--;
        if(left>0) setAnalyzing(left);
        else{
          clearInterval(tick);

          // indicators
          const pair = pairSel.value;
          const {type, rsi, ema, conf} = calcSignal(pair);

          // if WAIT -> still show, but no timer/modal (optional)
          setSignalUI(type, rsi, ema, conf);

          // message
          outEl.textContent = `${pairSel.value} ‚Ä¢ ${tfSel.value} ‚Äî Signal: ${type.toUpperCase()} | RSI ${rsi} | EMA200 ${ema} | Signal 1 daqiqa oldindan.`;
          addPendingLog(type);

          // only start timers if BUY or SELL (WAIT signals won't ask result)
          if(type !== "wait"){
            startTimerFlow();
          }else{
            // WAIT: clear time display a bit
            sigTimeEl.textContent = "üïí Kirish: ‚Äî | Tugash: ‚Äî (WAIT)";
          }
        }
      }, 1000);
    };

    render();

    /* ========= THREE.JS particle (blue + deep blue) ========= */
    const canvas = document.getElementById("bg");
    const renderer = new THREE.WebGLRenderer({ canvas, alpha:true, antialias:true });
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(55, 1, 0.1, 200);
    camera.position.z = 28;

    function resize(){
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(1, Math.floor(rect.width));
      const h = Math.max(1, Math.floor(rect.height));
      renderer.setSize(w, h, false);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }
    window.addEventListener("resize", resize);
    resize();

    const count = 7500;
    const geo = new THREE.BufferGeometry();
    const pos = new Float32Array(count*3);
    for(let i=0;i<count;i++){
      const i3=i*3;
      pos[i3+0] = (Math.random()-0.5)*70;
      pos[i3+1] = (Math.random()-0.5)*40;
      pos[i3+2] = (Math.random()-0.5)*40;
    }
    geo.setAttribute("position", new THREE.BufferAttribute(pos, 3));

    const mat = new THREE.PointsMaterial({ size: 0.08, transparent:true, opacity:0.9, depthWrite:false });
    mat.color = new THREE.Color(0x3B82F6);
    const points = new THREE.Points(geo, mat);
    scene.add(points);

    const mat2 = new THREE.PointsMaterial({ size: 0.12, transparent:true, opacity:0.35, depthWrite:false });
    mat2.color = new THREE.Color(0x0B1637);
    const points2 = new THREE.Points(geo, mat2);
    scene.add(points2);

    let t=0;
    function animate(){
      t += 0.0022;
      points.rotation.y = t*0.9;
      points.rotation.x = Math.sin(t*0.7)*0.12;
      points2.rotation.y = -t*0.55;
      points2.rotation.x = Math.cos(t*0.6)*0.10;
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }
    animate();
  </script>
</body>
</html>
